# Workflow to create a new tag release when a release branch is merged
name: Tag release

on:
  pull_request:
    types: [ closed ]
    branches:
      - release/*

jobs:
  tag-bump:
    if: |
      github.event.pull_request.merged == true &&
      (startsWith(github.event.pull_request.head.ref, 'release-pr') || startsWith(github.event.pull_request.head.ref, 'patch/'))
    runs-on: ubuntu-latest
    steps:
      - name: Git config
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/checkout@v4
        with:
          repository: argumentcomputer/ci-workflows
          path: ci-workflows
          # Remove after https://github.com/argumentcomputer/ci-workflows/pull/76 is merged
          ref: release-workflow
      # TODO: Refine changelog categories
      - name: Create changelog config
        run: |
          cat << 'EOF' > config.json
          {
            "template": "#{{CHANGELOG}}",
            "categories": [
              {
                  "title": "## Feature",
                  "labels": ["feat", "feature"]
              },
              {
                  "title": "## Fix",
                  "labels": ["fix", "bug"]
              },
              {
                  "title": "## ðŸ¤– CI",
                  "labels": ["automated-issue", "ci"]
              },
              {
                  "title": "## Other",
                  "labels": []
              }
            ]
          }
          EOF
      - uses: tibdex/github-app-token@v2
        id: generate-token
        with:
          app_id: ${{ secrets.TOKEN_APP_ID }}
          private_key: ${{ secrets.TOKEN_APP_PRIVATE_KEY }}
      - name: Publish release
        uses: ./ci-workflows/.github/actions/tag-release
        with:
          tag-prefix: sphinx
          changelog-config-file: ./config.json

